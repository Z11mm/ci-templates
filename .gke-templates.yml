variables:
  ROOT: ${ROOT}
  GCLOUD_SDK: ${GCLOUD_SDK}
  CLUSTER_NAME: ${CLUSTER_NAME}
  REGION: ${REGION}
  PROJECT: ${PROJECT}
  MANIFEST: ${MANIFEST}

stages:
  - deploy-dev
  - view

# Reusable job to deploy app to gke
.deploy-to-gke:
  stage: deploy-dev
  image: google/cloud-sdk
  # variables:
  #   ROOT: ${ROOT}
  #   GCLOUD_SDK: ${GCLOUD_SDK}
  #   CLUSTER_NAME: ${CLUSTER_NAME}
  #   REGION: ${REGION}
  #   PROJECT: ${PROJECT}
  #   MANIFEST: ${MANIFEST}
  script:
    - echo "Deploying app..."
    - ls -al
    - gcloud auth activate-service-account --key-file ${ROOT}/serviceaccount.json
    - gcloud container clusters get-credentials ${CLUSTER_NAME} --region=${REGION} --project=${PROJECT}
    - kubectl apply -f ${MANIFEST}

# Reusable job to view deployed app
.verify-deployment:
  stage: view
  script:
    - gcloud auth activate-service-account --key-file ${ROOT}/serviceaccount.json
    - gcloud container clusters get-credentials ${CLUSTER_NAME} --region=${REGION} --project=${PROJECT}
    - kubectl get all

# Use reusable jobs in pipeline
deploy-dev:
  extends: .deploy-to-gke
  only:
    - main

view-app:
  extends: .verify-deployment
  dependencies:
    - deploy-dev
  only:
    - main
